<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Python 3, Bottle.py, Apache and WSGI - Import Nightmares</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@_cmry" /><meta name="twitter:title" content="Python 3, Bottle.py, Apache and WSGI - Import Nightmares" /><meta name="twitter:description" content="At some point in a webdev’s life, one might consider moving away from classic web development in for example PHP, and move on to more convenient frameworks. If you already know a language, learning..."><meta name="description" content="At some point in a webdev’s life, one might consider moving away from classic web development in for example PHP, and move on to more convenient frameworks. ..."><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"> <script type="text/x-mathjax-config"> MathJax.Hub.Config({tex2jax: {inlineMath: [["$","$"], ['\\(','\\)']]}});</script> <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="canonical" href="/notes/bottle"><link rel="alternate" type="application/atom+xml" title="Chris Emmery" href="/feed.xml" /></head><body><aside class="logo"><nav> <a href="https://cmry.github.io"><i class="fa fa-home"></i></a> · <a href="https://www.github.com/cmry"><i class="fa fa-github"></i></a> · <a href="https://www.twitter.com/_cmry"><i class="fa fa-twitter"></i></a> · <a id="ind-publ" href="/publications/">publ</a> · <a id="ind-code" href="/code/">code</a> · <a id="ind-work" href="/work/">work</a> · <a id="ind-about" href="/about/">about</a></nav></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Python 3, Bottle.py, Apache and WSGI - Import Nightmares</h1><time>September 24, 2015</time></div><div class="divider"></div><p>At some point in a webdev’s life, one might consider moving away from classic web development in for example PHP, and move on to more convenient frameworks. If you already know a language, learning another one just for web development can also seem like a waste of time. Alternatives might be more elegant, flexible, and better integrated with the things you’re currently writing. I found myself in the position of having to demo my work on <a href="https://www.uni-weimar.de/medien/webis/events/pan-15/pan15-web/author-profiling.html">author profiling</a> that was completely written in Python 3 (<code class="highlighter-rouge">shed</code> + <code class="highlighter-rouge">sklearn</code>). The problem with framework switching, I found, is learning how to do frustratingly arbitrary operations all over again. Moreover, however sluggish <a href="https://en.wikipedia.org/wiki/LAMP_%28software_bundle%29">LAMP</a> set-ups might seem, they are very robust, well-understood and have plenty of documentation. Changing to more obscure environments like I did with <code class="highlighter-rouge">bottle.py</code> can shovel you in the face at any point. It’s been a bumpy road to say the least, so to help any pursuers of this path in the future, I hereby present you with my findings thus far.</p><h2 id="bottlepy">Bottle.py</h2><p><a href="http://bottlepy.org/docs/dev/index.html">Bottle.py</a> is a very minimalistic web- framework for Python. It is so small that delivering <code class="highlighter-rouge">hello world</code> to a port is literally this:</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="s">"""file: helloworldinabottle.py"""</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span>

<span class="nd">@route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"hello world"</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div><p>It works with all your existing code and libraries that Python has. So say that you want to test an already trained SVM classifier with <a href="http://scikit-learn.org/stable/modules/feature_extraction.html#common-vectorizer-usage">bigram</a> features on data fed by a query it can be as much as:</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="s">"""file: some_ml_example.py"""</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'/somedir/model.pickle'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">))</span>
<span class="n">big</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'/somedir/bigram_vectorizer.pickLe'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">))</span>

<span class="nd">@route</span><span class="p">(</span><span class="s">'/&lt;query&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">big</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">query</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">)</span>
</code></pre></div><p>That’s right, no POST, no GET, you can directly feed a string to <code class="highlighter-rouge">localhost</code> if you desire (you can definitely also use POST and GET). And with these few lines of code I was completely blown away by the elegance of the framework. Everything pretty much peachy, until you actually want to implement your app in an existing web server environment. Chances are huge that this will be in Apache. Traditional protocols for Apache do not handle these kind of apps, though, and so WSGI was brought to life.</p><h2 id="apache--wsgi">Apache &amp; WSGI</h2><p>Without filling this post with the <a href="http://www.fullstackpython.com/wsgi-servers.html">specifics</a> and motivations behind WSGI, let’s immediately jump into how to configure Bottle.py and Apache to run this stuff. First we need to do a bit of work in our <code class="highlighter-rouge">some_ml_example.py</code> that had the bottle code. After renaming it to <code class="highlighter-rouge">app.wsgi</code> it should contain the following:</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="s">"""file: app.wsgi"""</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">bottle</span>
<span class="kn">from</span> <span class="nn">beaker.middleware</span> <span class="kn">import</span> <span class="n">SessionMiddleware</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">SessionMiddleware</span><span class="p">(</span><span class="n">bottle</span><span class="o">.</span><span class="n">app</span><span class="p">())</span>

<span class="n">clf</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'/somedir/model.pickle'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">))</span>
<span class="n">big</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'/somedir/bigram_vectorizer.pickLe'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">))</span>

<span class="nd">@bottle.route</span><span class="p">(</span><span class="s">'/&lt;query&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">big</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">query</span><span class="p">])</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

</code></pre></div><p>So obviously we are not serving to a port anymore. Apache will pick up the app and serve it to wherever you wish. The <code class="highlighter-rouge">path</code> part is important as the directory orientation changes when everything is loaded into Apache, so your new app still needs to know where all the files are at. Notice that we’ve also added a dependency; <code class="highlighter-rouge">beaker</code>. Beaker does… Now that our file is done, we need to configure Apache to fetch it. In Linux, this is done as follows:</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">cd</span> /etc/apache2/sites-available
nano yourappname.conf
</code></pre></div><p>Around the web, I found the tendency for people to explain that adding a <code class="highlighter-rouge">bottle</code> application to Apache requires the following config:</p><div class="highlighter-rouge"><pre class="highlight"><code>WSGIDaemonProcess yourapp user=you group=somegroup processes=1 threads=5
<span class="nt">&lt;Directory</span> <span class="err">/</span><span class="na">home</span><span class="err">/</span><span class="na">directory</span><span class="err">/</span><span class="na">to</span><span class="err">/</span><span class="na">webserver</span><span class="err">/</span><span class="na">html</span><span class="err">/</span><span class="na">appdir</span><span class="err">/</span><span class="na">app</span><span class="err">.</span><span class="na">wsgi</span><span class="nt">&gt;</span>
  WSGIProcessGroup somegroup
  WSGIApplicationGroup %{GLOBAL}
  Order deny,allow
  Allow from all
<span class="nt">&lt;/Directory&gt;</span>
</code></pre></div><p>If all is well, and <a href="https://code.google.com/p/modwsgi/"><code class="highlighter-rouge">mod_wsgi</code></a> is installed and loaded into Apache, at least the <code class="highlighter-rouge">route("/")</code> we used in <code class="highlighter-rouge">helloworldinabottle.py</code> should be working after an Apache restart or reload. Now, however that may be true and may or not work for everyone, it was working fine for my previous websites. Not for this one, though.</p><h2 id="the-wsgi-deadlock">The WSGI Deadlock</h2><p>When I started to work on the demo, and tried to load an example similar to <code class="highlighter-rouge">some_ml_example.py</code> that included <code class="highlighter-rouge">import sklearn</code>, the bottle page where it was loaded would hang up. Just loading forever, and the Apache error log would not report anything. After searching all the possible query combinations of “apache bottle import module page hangs should I quit building websites starting now”, I found one particular page that described part the issue on stackoverflow. Case in point is what’s called a deadlock; when applications are not assigned to a system-wide application group, they are considered to be an instance of Apache. Now, Apache doesn’t like doing any heavy lifting in terms of loading of interpreting, caching and running processes; that’s why most of that stuff is capped to a maximum amount of CPU and Memory load. This is why <code class="highlighter-rouge">imports</code> of very large packages take forever and will probably never resolve in any time that users of your website would want to wait. Now, the issue <strong>should</strong> actually already be resolved! After all, we included the WSGI Applictiongroup to be <code class="highlighter-rouge">%{GLOBAL}</code>, which should do processing on the local system. Apparently that’s not working very well now is it? I carried on looking up what might be the issue, when I struck upon another stackoverflow post that mentioned specifying the Process and Applicationgroup separately in newer versions of <code class="highlighter-rouge">mod_wsgi</code>. The changes required for this are again done in the <code class="highlighter-rouge">/etc/apache2/sites-enabled/yourapp.wsgi</code>, as follows:</p><div class="highlighter-rouge"><pre class="highlight"><code>WSGIDaemonProcess yourapp user=you group=somegroup processes=1 threads=5
WSGIApplication /yourapp /dir/to/app/app.wsgi process-group=yourapp application-group=%{GLOBAL}
<span class="nt">&lt;Directory</span> <span class="err">/</span><span class="na">home</span><span class="err">/</span><span class="na">directory</span><span class="err">/</span><span class="na">to</span><span class="err">/</span><span class="na">webserver</span><span class="err">/</span><span class="na">html</span><span class="err">/</span><span class="na">appdir</span><span class="err">/</span><span class="na">app</span><span class="err">.</span><span class="na">wsgi</span><span class="nt">&gt;</span>
  WSGIProcessGroup %{GLOBAL}
  WSGIApplicationGroup %{GLOBAL}
  Order deny,allow
  Allow from all
<span class="nt">&lt;/Directory&gt;</span>
</code></pre></div><p>Now after a good <code class="highlighter-rouge">sudo service apache2 restart</code> you application should be working as expected! Hope this helped!</p></article><div class="back"> <a href="/"></a></div></main></body></html>