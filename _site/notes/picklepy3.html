<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Quicksnip - Pickle Problems in Python 3</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@_cmry" /><meta name="twitter:title" content="Quicksnip - Pickle Problems in Python 3" /><meta name="twitter:description" content="Python 3 has been out for quite some time, and it’s still notoriously ignored by the majority of the community. Luckily, all major libraries that I make use of have already made the small leap and ..."><meta name="description" content="Python 3 has been out for quite some time, and it’s still notoriously ignored by the majority of the community. Luckily, all major libraries that I make use ..."><link rel="stylesheet" type="text/css" href="/assets/light.css" /><link rel="alternate stylesheet" type="text/css" href="/assets/dark.css" title="dark" /><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"> <script type="text/x-mathjax-config"> MathJax.Hub.Config({tex2jax: {inlineMath: [["$","$"], ['\\(','\\)']]}});</script> <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <script type="text/javascript" src="/assets/styleswitcher.js"></script><link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="canonical" href="/notes/picklepy3"><link rel="alternate" type="application/atom+xml" title="Chris Emmery" href="/feed.xml" /></head><body><aside class="logo"><nav><div class="links"> <a href="/"><i class="fa fa-home"></i></a> » <a id="ind-publ" href="/publ">publ</a> » <a id="ind-code" href="/code">code</a> » <a id="ind-work" href="/work">work</a> » <a id="ind-about" href="/about">about</a></div></nav></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><h1>Quicksnip - Pickle Problems in Python 3</h1><time>September 7, 2015 | 2 minute read </time><div class="divider"></div><p>Python 3 has been out for quite some time, and it’s still notoriously ignored by the majority of the community. Luckily, all major libraries that I make use of have already made the small leap and as behaviour has only been slightly changed I never ran into any Py3 specific issues. Until today, that is. After writing quite the collection of classes, and storing their initialized states along with several module-specific objects all in one container, it was ready to be pickled and transferred. My fingers being crossed and naive high hopes notwithstanding, after a few lines of log code rolled over the screen the following presented itself:</p><div class="highlighter-rouge"><pre class="highlight"><code>_pickle.PicklingError: Can't pickle &lt;class 'dict_keys'&gt;: attribute lookup
dict_keys on builtins failed
</code></pre></div><p>Having no clue what went wrong yet, I instinctively looked up the error - and was presented by the dreaded scenario as so well described by xkcd:</p><p><img src="http://imgs.xkcd.com/comics/wisdom_of_the_ancients.png" alt="xkcd" /></p><p>In my case, however, it was just a single dumped log <a href="https://paste.openttdcoop.org/peze0kbvt">snippet</a>. Crap. The chances of these dumps being linked in a chat somewhere are way higher than them actually being traceable. And although this was the case, the <a href="http://irclogs.qmsk.net/channels/openttd/date/2015-02-16?page=4">IRC server</a> was friendly enough to log the conversation. That pretty much saved my monday morning. Turned out the bug was actually not that complex, and it has to do with the Py2 to Py3 transition of merging the good old <code class="highlighter-rouge">dict.iterkeys</code> commando into <code class="highlighter-rouge">dict.keys</code>. Let’s reproduce:</p><div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Foo</span><span class="p">:</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="o">...</span>         <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">'John'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'Marie'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="o">...</span>         <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pickle</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s">'foo.pickle'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">))</span>
</code></pre></div><p>Which again yields <em>_pickle.PicklingError: Can’t pickle &lt;class ‘dict_keys’&gt;: attribute lookup dict_keys on builtins failed</em>. It didn’t occur to me at first that the <code class="highlighter-rouge">dict_keys</code> type was hereby converted into a generator. It’s pretty much hidden away in:</p><div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="nb">type</span><span class="p">({</span><span class="s">'John'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'Marie'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">dict_keys</span><span class="s">'&gt;</span><span class="err">
</span></code></pre></div><p>In retrospect, this makes a lot of sense as the <code class="highlighter-rouge">iter</code> method was <em>intended</em> to be a generator version for dealing with big dictionaries. There are very good reasons why one should not want to pickle a generator. Quoting <a href="http://peadrop.com/blog/2009/12/29/why-you-cannot-pickle-generators/">Alexandre Vassalotti</a> :</p><blockquote><p>Since a generator is essentially a souped-up function, we would need to save its bytecode, which is not guarantee to be backward-compatible between Python’s versions, and its frame, which holds the state of the generator such as local variables, closures and the instruction pointer. And this latter is rather cumbersome to accomplish, since it basically requires to make the whole interpreter picklable. So, any support for pickling generators would require a large number of changes to CPython’s core.</p></blockquote><p>Anyway, problem solved. To make this mistake better recorded I thought I might as well post it. Hope it helps!</p></article><div class="back"> <a href="/"></a></div></main></body></html>